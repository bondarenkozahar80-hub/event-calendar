# Event Calendar Microservice

Микросервис «Календарь событий» — HTTP-сервис для управления событиями с поддержкой напоминаний, фоновых задач и асинхронного логирования.

---

## Основные возможности

- Создание, обновление, удаление событий
- Напоминания по email с поддержкой поля `remind_at`
- Фоновый воркер через канал для обработки напоминаний
- Асинхронный логгер через канал
- Чистка старых событий в отдельной горутине
- Хранение данных в PostgreSQL с хранением времени
- JWT-аутентификация пользователей

---

## API
| Метод  | Путь               | Описание                 | Параметры                                 | Тело запроса                                                                                        | 
|--------|--------------------|--------------------------|-------------------------------------------|-----------------------------------------------------------------------------------------------------| 
| POST   | /auth/sign-up      | Регистрация пользователя | —                                         | `{ "email": "user@example.com", "password": "password123" }`                                        | 
| POST   | /auth/sign-in      | Авторизация пользователя | —                                         | `{ "email": "user@example.com", "password": "password123" }`                                        | 
| POST   | /api/v1/events     | Создать событие          | —                                         | `{ "date": "2025-01-01T00:00:00Z", "description": "Event", "remind_at": "2025-01-01T12:00:00Z" }`   | 
| GET    | /api/v1/events     | Получить события         | `?period=[day,week,month]&date=YYYY-MM-DD | —                                                                                                   |
| PUT    | /api/v1/events/:id | Обновить событие         | `id` — UUID события                       | `{ "date": "2025-01-01T00:00:00Z", "description": "Updated", "remind_at": "2025-01-01T12:00:00Z" }` | 
| DELETE | /api/v1/events/:id | Удалить событие          | `id` — UUID события                       | —                                                                                                   | 

## Структура проекта

```
event-calendar/
├─ cmd/app/main.go               # Точка входа в приложение, запускает сервер
├─ internal/                     # Основной код сервиса
│  ├─ config/config.go           # Загрузка конфигурации из env
│  ├─ event/                     # Модуль работы с событиями
│  │  ├─ mocks/                  # Моки для тестов событий
│  │  ├─ repo/                   # Репозиторий для работы с событиями
│  │  ├─ rest/                   # HTTP-хендлеры для работы с событиями
│  │  ├─ service/                # Бизнес-логика для работы с событиями
│  │  ├─ worker/                 # Фоновые воркеры
│  │  │  ├─ reminder/reminder.go # Воркер для отправки напоминаний
│  │  │  └─ janitor/janitor.go   # Воркер для чистки/архивации старых событий
│  ├─ middlewares/auth.go        # JWT-аутентификация и middleware
│  ├─ response/response.go       # Утилиты для формирования HTTP-ответов
│  ├─ router/router.go           # Настройка API маршрутов
│  ├─ types/domain & dto         # Типы данных, структуры запросов/ответов (DTO)
│  ├─ user/                      # Модуль работы с пользователями
│  │  ├─ mocks/                  # Моки для тестов пользователей
│  │  ├─ repo/                   # Репозиторий для работы с пользователями
│  │  ├─ rest/                   # HTTP-хендлеры для работы с пользователями
│  │  └─ service/                # Бизнес-логика для работы с пользователями
│  ├─ validator/validator.go     # Валидация DTO и входящих данных
├─ docker-compose.yml            # Конфигурация Docker для БД и миграций
├─ Makefile                      # Удобные команды для запуска/тестов
├─ migrations/                   # SQL миграции для PostgreSQL
├─ logs/app.log                  # Файл логов сервиса
└─ pkg/                          # Вспомогательные пакеты
    ├─ db/                       # Обёртки для работы с базой данных
    ├─ email/                    # Отправка email-уведомлений
    ├─ errutils/                 # Утилиты для работы с ошибками
    ├─ jwt/                      # Работа с JWT
    └─ logger/                   # Асинхронный логгер и события логирования
````

---

## Установка и запуск

1. Клонируйте репозиторий:
```bash
git clone github.com/ilam072/event-calendar
cd event-calendar
```

2. Создайте файл .env в корне проекта, скопировав и изменив значения из .env.example:
```bash
cp .env.example .env
```

3. Запустите проект:
```bash
make up
```
---

## Примеры запросов

### Создание события

```http
POST api/v1/events
Content-Type: application/json
Authorization: Bearer <jwt-token>

{
  "date": "2025-01-01T12:00:00Z",
  "description": "Новый год!",
  "remind_at": "2024-12-31T12:00:00Z"
}
```

### Получение событий

```http
GET api/v1/events?period=day&date=2025-01-01
Authorization: Bearer <jwt-token>
```

### Обновление события

```http
PUT api/v1/events/<event_id>
Content-Type: application/json
Authorization: Bearer <jwt-token>

{
  "date": "2025-01-01T13:00:00Z",
  "description": "Обновлённое событие",
  "remind_at": "2024-12-31T12:30:00Z"
}
```

### Удаление события

```http
DELETE api/v1/events/<event_id>
Authorization: Bearer <jwt-token>
```

---

## Тесты

```bash
make test
```

---

## Особенности

* Напоминания обрабатываются через канал в отдельном воркере.
* Старые события автоматически архивируются через `janitor`.
* Логирование происходит асинхронно через канал в `logger`.

---

## Makefile

* `make up`: запустить проект 
* `make down`: остановить и удалить контейнеры 
* `make test`: запустить тесты 
